---
title: "Ontology models -- revised"
author: "Roberto Viviani, University of Innsbruck"
date: "2024-10-13"
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

This markdown contains revised analysis for the manuscript "AI-driven assessment of semantic similarity and association of responses between the 'Big Five' and DSM-5/ICD-11 personality traits", by Karin Labek, Sandra Bennett-Long, and Roberto Viviani.

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.dim = c(8,5.2))
library(ggplot2)
library(dplyr)
library(tidyr)

# utilities to decode embeddings
source("embedding_utilities.R") 
embeddings <- loadEmbeddings("embeddings_openAI_large_de.csv")

#we read the participant scores (only PID and NEO scores)
#the data are not available in the repository because of data privacy constraints
scales <- read.csv("scales_data_extended.csv")

#correlation of responses between PID and NEO items
cormx <- cor(as.matrix(scales |> select(starts_with("NEOFFI"))), 
    as.matrix(scales |> select(starts_with("PID5BF"))))
cordata <- data.frame(corrs = as.vector(cormx), cosdist = as.vector(embeddings$cdist),
                      typeNEO = embeddings$NEO$type, 
                      typePID = rep(embeddings$PID$type, each = nrow(embeddings$NEO)),
                      itemNEO = embeddings$NEO$itemID, 
                      itemPID = rep(embeddings$PID$itemID, each = nrow(embeddings$NEO)))
# typos in the dataset
cordata[cordata$typePID == "eccentrictiy", "typePID"] <- "eccentricity" 
cordata[cordata$typePID == "intimicy avoidance", "typePID"] <- "intimacy avoidance"
cordata$traitPID <- traits[cordata$typePID]

# create a group ordering for PID facets that respects traits
library(forcats)
traits <- as.integer(as.factor(cordata$traitPID))
traits <- traits * -20 + as.integer(as.factor(cordata$typePID))
cordata$typePID <- fct_reorder(cordata$typePID, traits)

rm(cormx)

# plotting utilities
source("plot_utilities.R")

# stat utilities
source("stats_utilities.R")

pidtraits <- c("PIDAnankastia", "PIDAntagonism", "PIDDetachment",
               "PIDDisinhibition", "PIDNegativeAffect", "PIDPsychoticism")
traitnames <- c("Anankastia", "Antagonism", "Detachment",
               "Disinhibition", "NegativeAffect", "Psychoticism")
neonames <- c("NEOvertr", "NEOgew", "NEOextra", "NEOneuro", "NEOoff")
neotraits <-c("NEOvertr" = "agreeableness", 
              "NEOgew" = "conscientiousness", 
              "NEOextra" = "extraversion", 
              "NEOneuro" = "neuroticism", 
              "NEOoff" = "openness")

## additional variables in revised

corstats <- cordata |> group_by(typeNEO, traitPID) |> summarise(avgdist = mean(cosdist), avgcorr = mean(corrs), meddist = median(cosdist), medcorr = median(corrs), lqcorr = quantile(corrs, 0.25), hqcorr = quantile(corrs, 0.75), maxcorr = max(corrs), mincorr = min(corrs))
cordataex <- left_join(cordata, corstats, by = c("typeNEO", "traitPID"))
cordataex$pair <- forcats::fct_cross(cordataex$typeNEO, cordataex$traitPID)
cordataex$pair <- forcats::fct_relevel(cordataex$pair, "Openness:Antagonism")


```


## Associations between scales

The average correlation between NEO and PID scales, computed from the correlation of the items, is shown in the following figures.

```{r, message = FALSE}
txt <- data.frame()
for (pid in pidtraits) {
  tx <- pearscorr(scales, pid, neonames)
  tx[,"PIDdomain"] <- pid
  tx[,"NEOtrait"] <- neotraits[row.names(tx)]
  row.names(tx) <- NULL
  tx <- tx[,c("PIDdomain", "NEOtrait", "r", "t", "p", "pcorr")]
  txt <- rbind(txt,tx)
}

ggplot(txt, aes(y = r, x = NEOtrait, fill = PIDdomain)) + 
  geom_col(position = "dodge") +
  scale_fill_viridis_d(option = "E") + 
  labs(fill = "PID domain") + 
  xlab("NEO trait") + ylab("correlation") + theme_grey() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

ggplot(txt, aes(y = r, x = PIDdomain, fill = NEOtrait)) + 
  geom_col(position = "dodge") +
  scale_fill_viridis_d() + 
  labs(fill = "NEO trait") + 
  xlab("PID domain") + ylab("correlation") + theme_grey() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

print(txt)

```

Because there are 30 combinations between subscale pairs, a threshold of t ~ 3.5 in the printout above would required to reject the null after correcting for mutiple testing. As one may expect, most subscales are correlated, with the largest association being between negative affect and neuroticism. Neuroticism has positive correlations, all other NEO traits have negative correlations.

## Response correlations and semantic similarity

The question of interest here, however, is not the existence of associations between NEO and PID subscales but the extent to which this may be demonstrably due to semantic similarities between the subscales. Below is a boxplot of correlations between the NEO and PID item pairs, ordered by the average semantic distance between the items of the subscales.

```{r, message = FALSE}
ggplot(cordataex, aes(x=meddist, y=corrs)) + 
  geom_boxplot(aes(group = pair), alpha = 0.5, staplewidth = 60) + 
  geom_rect(data = corstats, aes(xmin = meddist-0.001, xmax = meddist+0.001, ymin = lqcorr, ymax = hqcorr, fill = typeNEO), inherit.aes = F, alpha = 0.65) +
  geom_point(data = corstats, aes(x = meddist, y = medcorr, shape = traitPID), size = 3) +
  geom_hline(yintercept = 0, alpha = 0.5) +
  scale_x_continuous() + theme_classic() + scale_color_viridis_d() + scale_fill_viridis_d() + labs(color = NULL, fill = "NEO trait", x = "median scale pair distance")

```

From this plot, one can see that at high semantic distances (i.e., > 0.65) there is no average correlation between responses and distance. At lower distances, correlations start to emerge. Note, however, that correlations may be positive as well as negative: the median correlations diverge at lower distances (the exception is conscientiousness and anakastia). Semantic distances are known to be low for antonyms (as antonyms occur in the same textual context), so what we have is that semantic distance predicts both positive and negative correlation. This is a convenient feature of embeddings from large language models, as scales may in general vary the direction in which they are scored.

To formally test that semantic distance is predictive of correlation between the subscales, we model the absolute average correlation (instead of the signed correlation) as an effect of average semantic distance between the subscales. We use a logistic binomial model to take into account that now the absolute average correlations are positive. The test and the corresponding plot of the fit are below.


```{r, message = FALSE, warning = FALSE}
summary(glm(abs(corr) ~ dist, 
            data = cordata |> group_by(typeNEO, traitPID) |> summarize(corr = mean(corrs), dist = mean(cosdist)), 
            family = quasibinomial))
ggplot(
  cordata |> group_by(typeNEO, traitPID) |> summarize(corr = mean(corrs), dist = mean(cosdist)),
  aes(y = abs(corr), x = dist)) + 
  geom_point(aes(color = typeNEO, shape = traitPID), alpha = 0.8, size = 4) +
  geom_smooth(method = "glm", method.args = c("family"="quasibinomial"), 
    alpha = 0.2, color = "darkgrey") + 
  scale_color_viridis_d() + 
  labs(color = "NEO trait", shape = "PID domain") + 
  xlab("semantic distance") + ylab("avg correlation") + theme_classic()
ggsave("subscales_openAI_large.pdf", width = 150, height = 95, units = "mm")

```

The test shows that semantic distance significantly predicts the absolute correlation between the subscale pairs.

## Modelling predicted correlation of item pairs

There are limitations with this model, however. One is that the average semantic distance within subscales may be a poor predictor of response correlations when this distance varies a lot in the subscale item pairs. Indeed, one may expect this when the content of one or the other subscales are heterogeneous. In the boxplot shown previously, we see that anankastia and conscientousness gave a poor association for the close semantic distance. However, this pair also contained the strongest item associations. When we plot the relationship between semantic distance and response correlation at the level of individual item pars within these subscales, we find that distance is highly predictive of response correlation, but since distances wary a lot the average prediction is much poorer.


```{r, message = FALSE, warning = FALSE }
ggplot(cordata |> filter(typeNEO == "Conscientiousness", traitPID == "Anankastia"), aes(x = cosdist, y = abs(corrs))) + 
  geom_point(aes(color = typePID), size = 3) + 
  geom_smooth(se = F, color = "darkgrey", method = "glm", 
              method.args = c(family=quasibinomial)) +
  theme_classic() + 
  labs(x = "semantic distance", y = "items correlation") +
  scale_color_viridis_d(end = 0.9, begin = 0.3, option = "G")
```

For this reason, while the model fitted above demonstrates that the associations between NEO and PID subscales are contaminated by semantic similarities, it is not the best model to assess the extent to which semantic similarity is itself predictive of association. 

The second limitation is that the associations may vary in direction within the same subscale pair. This will be especially the case if similar item pairs exist, but they have varying directionality. In the plot above, we see that some subscale pairs have correlations close to zero but the correlations of items span positive and negative values. In general, it may not be appropriate to consider average correlations.

To address these limitations, we may fit a model at the level of item pairs.

```{r}
fit <- glm(abs(corrs) ~ cosdist + pair, family = quasibinomial, data = cordataex)
cf <- summary(fit)$coefficients
cf["cosdist",]

# plot
cf <- coef(fit)
ggplot(cordataex, aes(x=cosdist, y=fitted(fit))) + 
  geom_point(aes(y = abs(corrs), color = typeNEO), alpha = 0.1) +
  geom_line(aes(color=typeNEO, linetype=traitPID), alpha = 1) + 
  geom_line(aes(y = plogis(cf[1]+cf["cosdist"]*cosdist)), color="black", linewidth = 1) + 
  labs(x = "semantic distance", y = "fitted response correlation", 
       linetype = "PID domain", color = "NEO trait") +
  scale_color_viridis_d() +
  theme_minimal()

```

We see that in this model the evidence for the effect of semantic distance is much larger (t = about 13). 

We need an intercept in this model, because the absolute correlation is always positive. However, we can also see that at distances of about 0.75, the correlation plateaus at about 0.05.

## Which scales are candidate genuine associations?

Once the existence of an association between semantic distance and response correlations has been demonstrated, the important question remains of response correlations that are larger than expected from what predicted by semantic distance. These are candidate genuine correlations, i.e. correlation over and above what one may expect from the semantic similarity of scale items.

What we see from the preceding figure is some subscale pairs show average correlation levels that are much higher than expected from the overall fit of the predicted correlation from semantic similarity (in black). While semantic distance is predictive of correlations, these subscale pairs have an absolute association that remains positive even at high semantic distances, such as 0.75, taken as a baseline correlation level. These are candidate genuine association pairs.

To estimate this quantity statistical and provide inference, we may rebase the semantic distance such that the intercept corresponds to the semantic distance 0.75. This quantity is given as the subscale pairs-specific intercept, whose confidence intervals give us an assessment of the extent to which the subscale pair is correlating higher than expected from the semantic similarity of their items.

A further improvement of the model is to allow the slopes to vary in each subscale pair. Because a model with fixed effects here gives the impression of overfitting, we use random effects for both intercepts and slopes. We log-transform the rates, as if they were odds, to fit a linear model. We use stan to get good estimate of intervals.

```{r}
library(rstanarm)
library(bayesplot)
cordataex$cosdist.b <- cordataex$cosdist - 0.75

fitlo <- stan_lmer(log(abs(corrs) / (1 - abs(corrs))) ~ cosdist.b + (cosdist.b || pair), data = cordataex, cores = 4)

plotdata <- as.matrix(fitlo)
plotdata <- plotdata[,3:32]
mcmc_intervals(plotdata) + geom_vline(xintercept = 0) + theme_minimal()
rm(plotdata)

```

As one can see, according to the model there are several candidate genuine associations. The largest is neuroticism/extraversion and negative affect, of course, but also conscientiousness and disinhibition appear to go very much beyond their semantic similarity.

We now plot the group-specific slopes.

```{r}
fitted <- fitlo$fitted.values
ggplot(cordataex, aes(x = cosdist, y = exp(exp(fitted)/(1+exp(fitted))))) + 
  geom_line(aes(color = typeNEO, linetype = traitPID), linewidth = 1, alpha = 0.9) + 
  scale_color_viridis_d() + 
  labs(x = "semantic distance", y = "fitted response corr.", 
       linetype = "PID domain", color = "NEO trait") + 
  theme_minimal()

```

There is a problem with extraversion and negative affect, which have a positive slope, as shown below:

```{r, message = FALSE }
ggplot(cordata |> filter(typeNEO == "Extraversion", traitPID == "NegativeAffect"), aes(x = cosdist, y = abs(corrs))) + geom_point(aes(color = typePID), size = 3) + theme_classic() + labs(x = "semantic distance", y = "items correlation") + scale_color_viridis_d(end = 0.9, begin = 0.3, option = "G") + 
  geom_smooth(method = "lm")
```

this turns out to be due to a genuine negative association between negative affect and the subscale anxiety, which at distance 0.6 is very far from the intercept.

```{r, message = FALSE }
ggplot(cordata |> filter(typeNEO == "Extraversion", traitPID == "NegativeAffect"), aes(x = cosdist, y = abs(corrs))) + geom_point(aes(color = typePID), size = 3) + theme_classic() + labs(x = "semantic distance", y = "items correlation") + scale_color_viridis_d(end = 0.9, begin = 0.3, option = "G") + 
  geom_smooth(aes(color = typePID), method = "glm", alpha = 0.2, method.args = c("family"="quasibinomial"))
```

This needs to be investigated further.

We can also check the intervals of the pair-specific slopes, to see where there was strong heteregeneity of semantic determination of responses:

```{r}
plotdata <- as.matrix(fitlo)
plotdata <- plotdata[,33:62]
mcmc_intervals(plotdata) + geom_vline(xintercept = 0) + theme_minimal()
rm(plotdata)

```

## beta binomial model

A way to improve on this model is to adopt a Bayesian framework to compute these confidence intervals. We use here a beta binomial model to model the overdispersion of rates, instead of using the quasibinomial family (the fractional logit), thus also verifying the robustness of our modelling strategy. Here, however, we are not modelling subscale pairs as random effects. For this reason, coefficients are relative to a reference intercept/reference slope, which that of the openness/antagonism pair. Futhermore, like the equivalent fractional logistic model, it tends to overfit the group-specific slopes. 

```{r}
library(rstanarm)
library(bayesplot)

cordataex$cosdist.b <- cordataex$cosdist - 0.75
fitb <- stan_betareg(abs(corrs) ~ pair + cosdist.b + cosdist.b:pair, link = "logit", data = cordataex, cores = 4)

plotdata <- as.matrix(fitb)
plotdata <- plotdata[,2:30]
mcmc_intervals(plotdata) + geom_vline(xintercept = 0) + theme_minimal()
rm(plotdata)

```

We now repeat the plot of the fitted response correlations, which turns out to be very similar to the one obtained with the fractional logit model with overdispersion (not shown here). The fractional logit can be used here because there are no random effects.


```{r}
ggplot(cordataex, aes(x = cosdist, y = fitb$fitted.values)) + 
  geom_line(aes(color = typeNEO, linetype = traitPID), linewidth = 1, alpha = 0.9) + 
  scale_color_viridis_d() + 
  labs(x = "semantic distance", y = "fitted response corr.", 
       linetype = "PID domain", color = "NEO trait") + 
  theme_minimal()

```

### References

Ferrari, SLP and Cribari-Neto, F (2004) “Beta Regression for Modeling Rates and Proportions”. Journal of Applied Statistics. Vol. 31, No. 07, p. 799-815.

Papke, Leslie E and Wooldridge, Jeffrey M (1996). "Econometric methods for fractional response variables with an application to 401(k) plan participation rates". Journal of Applied Econometrics 11:619-632.  (the fractional logistic model approach)

Kubinec, Robert (2023). Fixing fractional logit? https://www.robertkubinec.com/post/frac_logit/ (accessed 13.10.2024)

Kubinec, Robert (2022). Ordered beta regression: A parsimonius, well-fitting model for continuous data with lower and upper bounds. Political Analysis. 2023;31(4):519-536. doi:10.1017/pan.2022.20 

Wikipedia. Fracional model. https://en.wikipedia.org/wiki/Fractional_model
