---
title: "Models comparison"
author: "Roberto"
date: "2024-04-22"
output: word_document
---

We test the extent to which semantic similarity predicts the respondent correlation of answers across subscales using different large language models.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)

# utilities to decode embeddings
source("embedding_utilities.R") 

#when we read the scales, we drop the extranumerary NEO items
scales <- read.csv("scales_data_extended.csv") |> tidyr::drop_na() |> select(-NEOFFI61:-NEOFFI66)
getcordata <- function(cdist) {
  cormx <- cor(as.matrix(scales |> select(starts_with("NEOFFI"))), 
      as.matrix(scales |> select(starts_with("PID5BF"))))
  cordata <- data.frame(corrs = as.vector(cormx), cosdist = as.vector(cdist),
                        typeNEO = NEO$type, typePID = rep(PID$type, each = nrow(NEO)),
                        itemNEO = NEO$itemID, itemPID = rep(PID$itemID, each = nrow(NEO)))
  cordata$traitPID <- traits[cordata$typePID]
  cordata
}

# plot function
plotfunc <- function(data) {
  p <- ggplot(
    data |> group_by(typeNEO, traitPID) |> summarize(corr = mean(corrs), 
                                                     dist = mean(cosdist)),
    aes(y = abs(corr), x = dist)) + 
    geom_point(aes(color = typeNEO, shape = traitPID), alpha = 0.8, size = 4) +
    geom_smooth(method = "glm", method.args = c("family"="quasibinomial"), 
      alpha = 0.2, color = "darkgrey") + 
    scale_color_viridis_d() + 
    labs(color = "NEO scale", shape = "PID trait") + 
    xlab("semantic distance") + ylab("avg correlation") + theme_classic()
  p
}

# model and inference. Cosine distance standardized
testfunc <- function(data) {
  summary(glm(abs(corr) ~ scale(dist), 
    data = data |> group_by(typeNEO, traitPID) |> summarize(corr = mean(corrs), dist = mean(cosdist)),             family = quasibinomial))
}

# a utility function to load embeddings file and get rid of excess NEO items
readembeds <- function(file.csv, cleanNEO = TRUE) {
  embeddings <- read.csv(file.csv)
  if (cleanNEO)
    embeddings <- embeddings[!stringi::stri_detect_regex(embeddings$itemID, "NEOFFI6[1-6]"),]
  embeddings
}

```

## OpenAI, small vector embeddings

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_openAI_small_de.csv")

NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
testfunc(cordata)
#save one plot with scales (only this one)
#ggsave("subscales_legends.pdf", width = 150, height = 95, units = "mm")

#save without scales
ggsave("subscales_openAI_small.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Gecko

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_gecko_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_gecko.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```


```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_gecko_0409_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_gecko_0409.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Mistral

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_mistral_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_mistral.pdf",         
       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Aleph Alpha base compressed

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_alephalpha_base_128_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_mistral.pdf",         
       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```


## Aleph Alpha base full

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_alephalpha_base_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_alephalpha.pdf",         
       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_alephalpha_extended_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
#ggsave("subscales_alephalpha_extended.pdf",         
#       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
#       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_alephalpha_extended_max_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
#ggsave("subscales_alephalpha_extended.pdf",         
#       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
#       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```



```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_alephalpha_supreme_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
#ggsave("subscales_alephalpha_supreme.pdf",         
#       plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
#       width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Roberta

Roberta performs well.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_roberta_multilingual_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_roberta_multilingual.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## all-mpnet-base-v2

Like Roberta, this is a freely available model.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_mpnetbasev2_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## bert German (msmarco)

Like Roberta, this is a freely available model.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_bert_msmarco_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## BGE M3

Another freely available BERT model.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_BGEM3_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## E5

Another freely available BERT model.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_multilingual_e5_large_instruct_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_E5_multilingual.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Jina

Another freely available BERT model.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_jinav2base_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Universal Sentence Encoder

Universal Sentence Encoder embeddings are publicly available on the TensorFlow site.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_univSentEncoder_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
cordata  <- getcordata(crcosdist(embmx(NEO), embmx(PID)))

plotfunc(cordata)
ggsave("subscales_univSentEnc.pdf", 
        plot = plotfunc(cordata) + guides("color" = "none", "shape" = "none"),
        width = 150 * 2 / 3, height = 95 * 3 / 4, units = "mm")
testfunc(cordata)
rm(list = c("embeddings", "NEO", "PID", "cordata"))
```

## Averaged models

We look at whether performance can be improved by combining the information from models. We first pool our two best-performing models.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_openAI_large_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_openAI <- crcosdist(embmx(NEO), embmx(PID))

embeddings <- readembeds("embeddings_gecko_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_gecko <- crcosdist(embmx(NEO), embmx(PID))

distmx_pooled <- (scale(distmx_openAI) + scale(distmx_gecko)) / 2 

cordata_pooled <- getcordata(distmx_pooled)
plotfunc(cordata_pooled)
testfunc(cordata_pooled)
rm(list = c("embeddings", "NEO", "PID", "distmx_openAI", "distmx_gecko", 
     "distmx_roberta", "dismx_USE", "distmx_pooled", "cordata_pooled"))
```

This reveals that the average model performed similarly to the original models.

We add all models to the pool, to verify robustness to model selection. This indeed improves the statistics, although by not much.

```{r, message = FALSE, warning = FALSE}
embeddings <- readembeds("embeddings_openAI_large_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_openAI <- crcosdist(embmx(NEO), embmx(PID))

embeddings <- readembeds("embeddings_gecko_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_gecko <- crcosdist(embmx(NEO), embmx(PID))

embeddings <- readembeds("embeddings_univSentEncoder_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_USE <- crcosdist(embmx(NEO), embmx(PID))

embeddings <- readembeds("embeddings_roberta_multilingual_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_roberta <- crcosdist(embmx(NEO), embmx(PID))

embeddings <- readembeds("embeddings_alephalpha_base_de.csv")
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
distmx_alephalpha <- crcosdist(embmx(NEO), embmx(PID))

distmx_pooled <- (scale(distmx_openAI) + scale(distmx_gecko) + 
                    scale(distmx_roberta) + scale(distmx_USE) + 
                    scale(distmx_alephalpha)) / 5

cordata_pooled <- getcordata(distmx_pooled)
plotfunc(cordata_pooled)
testfunc(cordata_pooled)
rm(list = c("embeddings", "NEO", "PID", "distmx_openAI", "distmx_gecko", "distmx_alephalpha",
     "distmx_roberta", "dismx_USE", "distmx_mistral", "distmx_pooled"))
```

```{r embed_x_corr, message = FALSE }

library(ggplot2)
library(ggpubr)

p1 <- ggplot(cordata_pooled, aes(cosdist, corrs, color = typeNEO)) +  
  geom_smooth(aes(group = typeNEO), method = "lm", se = F, alpha = 0.5) + 
  geom_point(shape=21, alpha = 0.5) +
  scale_color_viridis_d(name = "NEO scale") + 
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

p2 <- ggplot(cordata_pooled, aes(cosdist, abs(corrs), color = typeNEO)) +  
  geom_smooth(aes(group = typeNEO), method = "glm", 
              method.args = c("family"="quasibinomial"), se = F) + 
  geom_point(shape=21, alpha = 0.5) +
  scale_color_viridis_d(name = "NEO scale") + 
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()
neocolours <- unique(layer_data()$colour)

mp <- ggarrange(p1, p2, ncol=2, nrow=1, common.legend = TRUE, legend = "right")
mp

```
