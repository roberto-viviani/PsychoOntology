---
title: "Ontology Models"
author: "Roberto Viviani, University of Innsbruck"
date: "2024-04-18"
output: word_document
---

```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.dim = c(8,5.2))
library(ggplot2)

library(Rcpp)
# define matlab's pdist2
cppFunction('NumericMatrix crossdist(NumericMatrix m1, NumericMatrix m2) {

  int nrow1 = m1.nrow();
  int nrow2 = m2.nrow();
  int ncol = m1.ncol();
 
  if (ncol != m2.ncol()) {
    throw std::runtime_error("Incompatible number of dimensions");
  }
 
  NumericMatrix out(nrow1, nrow2);
 
  for (int r1 = 0; r1 < nrow1; r1++) {
    for (int r2 = 0; r2 < nrow2; r2++) {
      double total = 0;
      for (int c12 = 0; c12 < ncol; c12++) {
        total += pow(m1(r1, c12) - m2(r2, c12), 2);
      }
      out(r1, r2) = sqrt(total);
    }
  }
 
  return out;

}')

embmx <- function(frm) {
  mx = matrix(nrow = nrow(frm), ncol = 3072)
  for (count in 1 : nrow(frm)) {
    eb <- frm[count,"embedding"]
    em <- sub("\\[", "c\\(", eb)
    em <- sub("\\]", "\\)", em)
    c <- eval(str2expression(em))
    mx[count,] <- c
  }
  mx
}

embeddings <- read.csv("embeddings_openAI_large_de.csv")

library(dplyr)
NEO <- filter(embeddings, scaleID == "NEO") |> select(itemID, type, embedding)
PID <- filter(embeddings, scaleID == "PID") |> select(itemID, type, embedding)
NEOmx <- embmx(NEO)
PIDmx <- embmx(PID)
rm(embeddings)

scales <- read.csv("scales_data.csv")
cdist <- crossdist(NEOmx, PIDmx)
cormx <- cor(as.matrix(scales |> select(starts_with("NEO"))), 
    as.matrix(scales |> select(starts_with("PID"))))
cordata <- data.frame(corrs = as.vector(cormx), cosdist = as.vector(cdist),
                      typeNEO = NEO$type, typePID = rep(PID$type, each = nrow(NEO)),
                      itemNEO = NEO$itemID, itemPID = rep(PID$itemID, each = nrow(NEO)))

```

We plot correlation on cosine distance of embeddings, to see if distance predicts correlation. We consider different NEO subscales separately.

```{r embed_x_corr, message = FALSE }

library(ggplot2)
ggplot(cordata, aes(cosdist, corrs, color = typeNEO)) + geom_point(shape=21) + 
  geom_smooth(aes(group = typeNEO), method = "lm", se = F) + 
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

This is as expected, except for conscientiousness. Here, we can show that with lower semantic distance the associations diverge into two groups.

```{r conscientiousness, message = FALSE}
ggplot(filter(cordata, typeNEO == "Conscientiousness"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(aes(group = corrs > 0), color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Conscientiousness", cosdist < 0.95), 
            aes(label = typePID), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

Furthermore, the items that associated positively with PID subscales concern rigidity and perfectionism. Distractability and irresponsibility are negatively associated with conscientiousness, meaning individuals who are more conscienscious are less distractable and irresponsible.

We now identify the items in the scale that are responsible for the negative association:

```{r conscientiousness_items, message = FALSE}
ggplot(filter(cordata, typeNEO == "Conscientiousness"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(aes(group = corrs > 0), color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Conscientiousness", cosdist < 0.95), 
            aes(label = paste(itemNEO, itemPID, sep=":")), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

NEO item 60 is "I strive for excellence in everything I do" (Bei allem, was ich tue, strebe ich nach Perfektion"). This ends up correlated with responses on "I keep approaching things the same way, even when it isn’t working" ("Auch wenn es andere zum Wahnsinn treibt, bestehe ich darauf, alles perfekt zu machen") and "I get stuck on one way of doing things, even when it’s clear it won’t work" ("Ich versuche Dinge weiter zu perfektionieren, auch wenn ich sie wahrscheinlich schon so gut wie möglich hinbekommen habe"). The differences in meaning between the German and English version are enough to produce different results in the semantic analysis: here, the notion of perfectionism drives a semantic association that is absent in the original English language (see Ontology.ipynb).

Extraversion, by contrast, appears to be so sparsely distributed because of the selective negative association of some items with anhedonia, anxiety, and withdrawal. Here, the language model detected semantic affinities between properties such as distractability and emotional lability that were not confirmed by higher response associations.

```{r extraversion, message = FALSE}
ggplot(filter(cordata, typeNEO == "Extraversion"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(aes(group = corrs > 0), color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Extraversion", 
                          (cosdist < 0.99 & corrs < -0.2) | cosdist < 0.9), 
            aes(label = typePID), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

Agreableness, in contrast, presents a weak and less specific negative association with the PID traits, with some stronger associations with manipulativeness and deceitfulness.

```{r agreeableness, message = FALSE}
ggplot(filter(cordata, typeNEO == "Agreeableness"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Agreeableness", cosdist < 0.99, corrs < -0.2), 
            aes(label = typePID), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

Finally, we show what appears to be a genuine association between low openness and anhedonia. "Genuine", because the language model detects no semantic affinity between the items of openness and anhedonia, but in some cases a negative association is present among participants.

```{r openness, message = FALSE}
ggplot(filter(cordata, typeNEO == "Openness"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Openness", corrs < -0.2), 
            aes(label = typePID), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

We can identify the NEO items that are responsible for these associations:

```{r openness_items, message = FALSE}
ggplot(filter(cordata, typeNEO == "Openness"), 
       aes(cosdist, corrs)) + 
  geom_point(aes(fill = typePID, color = typePID), alpha = 0.5, shape=21) + 
  geom_smooth(color = "grey", method = "lm", se = F) + 
  geom_text(data = filter(cordata, typeNEO == "Openness", corrs < -0.2), 
            aes(label = paste(itemNEO, itemPID, sep = ":")), alpha = 0.3) +
  xlab('semantic distance') + ylab('responses correlation') + theme_classic()

```

NEOFFI53, which shows the most negative correlations with PID28 and PID10, is the text I have a lot of intellectual curiosity" ("Ich bin sehr wissbegierig"). The correlated anhedonia PID items are "I rarely get enthusiastic about anything" ("Ich bin selten von irgendetwas begeistert") and "Nothing seems to interest me very much" ("Nichts scheint mich wirklich zu interessieren"). Here, the notion of intellectual curiosity appears to have been coded as being distinct from general enthusiasm and interest by the language model, but ends up correlating with anhedonia in the responses of participants.

Below, we plot the sample correlation of each NEO subscale with the total PID score on the average semantic distance with PID items. Because this correlation may be positive or negative (depending on the direction in which NEO subscales code), we used absolute values. One can see that the correlation between the NEO scores and the total PID scores across participants was larger when the average semantic distance to the PID items is smaller. As expected, the largest correlation accrued to the neuroticism scale. As described in the literature, openness to experience is not related to PID dimensions. We see that in both its large semantic distance and low correlation with total PID scores. The amount of correlation of consciontiousness is dominated by the perfectionism items.

```{r, message = FALSE}
NEOneurofld <- NEO |> filter(type == "Neuroticism") |> select(itemID)
NEOextrafld <- NEO |> filter(type == "Extraversion") |> select(itemID)
NEOopennfld <- NEO |> filter(type == "Openness") |> select(itemID)
NEOagreefld <- NEO |> filter(type == "Agreeableness") |> select(itemID)
NEOconscfld <- NEO |> filter(type == "Conscientiousness") |> select(itemID)
subscales <- data.frame(subjectID = scales$subjectID)
subscales$Neuro <- rowSums(select(scales, NEOneurofld$itemID))
subscales$Extra <- rowSums(select(scales, NEOextrafld$itemID))
subscales$Openn <- rowSums(select(scales, NEOopennfld$itemID))
subscales$Agree <- rowSums(select(scales, NEOagreefld$itemID))
subscales$Consc <- rowSums(select(scales, NEOconscfld$itemID))
subscales$PID <- rowSums(select(scales, starts_with("PID")))

scales_correlations <- cor(subscales$PID, select(subscales, -PID, -subjectID))

semantic_affinity = data.frame(
Neuro = mean(rowSums(cdist[NEO$type == "Neuroticism",]) / 36),
Extra = mean(rowSums(cdist[NEO$type == "Extraversion",]) / 36),
Openn = mean(rowSums(cdist[NEO$type == "Openness",]) / 36),
Agree = mean(rowSums(cdist[NEO$type == "Agreeableness",]) / 36),
Consc = mean(rowSums(cdist[NEO$type == "Conscientiousness",]) / 36)
)

affinities <- data.frame(NEO = c("Neuroticism", "Extraversion", "Openness", "Agreeableness", "Conscientiousness"), correlations = as.vector(scales_correlations), semantic_affinity = as.vector(as.matrix(semantic_affinity)))

ggplot(affinities, aes(semantic_affinity, abs(correlations))) + 
  geom_point(aes(color = NEO), size = 6) + 
  geom_smooth(method = "lm", se = F) + 
  geom_text(aes(x = semantic_affinity + 0.005, y = abs(correlations) - 0.02, label = NEO)) + 
  xlab("Semantic distance") + ylab("Abs. correlation NEO scale with PID total") + 
  theme_classic()
```

